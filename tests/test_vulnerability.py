import logging
import sys
import os

# Add the src directory to the Python path
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from src.core import (
    parse_verilog_to_dag,
    GadgetTransformer,
    CNFEncoder,
    solve_and_report
)
from src.core.output_comparator import add_output_mismatch_clauses

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def check_vulnerability(verilog_file: str, max_faults: int = 3) -> None:
    """
    Check a circuit for fault injection vulnerabilities.
    
    Args:
        verilog_file: Path to the Verilog file
        max_faults: Maximum number of faults to consider
    """
    logger.info(f"Analyzing circuit: {verilog_file}")
    
    # Step 1: Parse Verilog to DAG
    logger.info("Parsing Verilog file...")
    dag = parse_verilog_to_dag(verilog_file)
    dag.visualize() 
    
    # Step 2: Transform circuit with fault gadgets
    logger.info("Adding fault gadgets...")
    transformer = GadgetTransformer(dag.graph, dag.fault_points)
    transformed_dag = transformer.transform()
    
    # Step 3: Encode to CNF
    logger.info("Encoding to CNF...")
    encoder = CNFEncoder(transformed_dag)
    
    # Add constraints
    encoder.add_constraint_max_faults(max_faults)
    
    # Add output mismatch condition
    add_output_mismatch_clauses(encoder, [("out", "out_protected")], "oflag")
    
    # Get CNF and variable mapping
    cnf = encoder.get_cnf()
    var_map = encoder.get_var_map()
    
    # Step 4: Solve and analyze
    logger.info("Solving SAT instance...")
    solve_and_report(
        cnf=cnf,
        var_map=var_map,
        keys_to_monitor=["out", "out_protected", "oflag", "c1", "c2", "c3"]
    )

def main():
    """Main function to demonstrate vulnerability checking."""
    # Example usage with test circuit
    check_vulnerability("../examples/test_multi_module.v", max_faults=3)

if __name__ == "__main__":
    main() 